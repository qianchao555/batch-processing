### 视图

#### 什么是视图

视图：本质是一种虚拟表，在物理上不存在的，其内容与真实的表相似，包含一系列带有名称的列和行数据。但是，视图并不在数据库中以存储的数据值存在。行和列数据来自定义视图的查询所引用的基本表，并且在具体引用视图时动态生成。

#### 为什么使用视图

为了提高复杂SQL语句的复用性和表操作的安全性

视图使得开发者只关心感兴趣的某些特定数据和所负责的特定任务，只能看到视图中所定义的数据，从而提高了数据库中数据的安全性

#### 视图的特点

1. 视图的列可以来自不同的表
2. 视图是由基本表产生的虚表
3. 视图的建立和删除不影响基表
4. 对视图的更新(添加、删除、修改)直接影响基表。由于视图是虚表，所有对视图的更新操作实际上是对其基本的更新操作
5. 当视图来自多个基本时，不允许添加和删除数据



#### 创建视图

~~~mysql
create view 视图名 as 子查询 ;

#或者
create or replace view 视图名
~~~



### 存储过程

存储过程是一个预编译的SQL语句。优点是允许模块化的设计，只需要创建一次，以后在程序中就可以调用多次。

如果某次操作需要执行多次SQL，使用存储过程比单纯SQL语句执行要快

#### 优点

1. 存储过程是预编译过的，执行效率高
2. 存储过程的代码直接存放于数据库中，通过存储过程名直接调用，减少网络通讯
2. 安全性高，执行存储过程需要有一定权限的用户
2. 存储过程可以重复使用，减少数据库开发人员的工作量

#### 缺点

1. 调试麻烦，但是PL/SQL Developer调试很方便，弥补了这个缺点
2. 移植问题，数据库端代码是于数据库相关的。
3. 重编译问题，后端代码运行前需编译，如果带有引用关系的对象发生改变时，受影响的存储过程、包 将需要重新编译



#### 存储过程基础

##### 存储过程结构

1. 基本结构

   存储过程包含三部分：过程声明、执行过程部分、存储过程异常(可写可不写，要增强脚本的容错性和调试的方便性那就写上异常处理)

2. 无参存储过程

   ~~~sql
   create or replace procedure demo as/is
   	变量1 date;
   	变量2 number;
   begin 
   	#要处理的业务逻辑
   	exception  #存储过程异常
   end
   
   
   #demo  代表存储过程名称
   #as/is  任选一个
   ~~~

   

3. 有参存储过程

   ~~~sql
   create or replace procedure demo1Procedure( id int,  name varchar) as 
   age number :=20;
   
   begin 
   	select * from db1 where age=12;
   end;
   
   
   
   ~~~

4. 有参存储过程in、out、in out

   ~~~sql
   create or replace procedure 存储过程名称(parm1 in 类型1, parm2 out 类型2)
   
   
   create or replace procedure 存储过程名称(parm1 类型1, parm2 out 类型2)
   
   # 参数默认为in 类型,表示输入参数
   #out 表示返回值参数
   #in out 表示该参数可以向该过程中传递值，也可以将某个值传出去
   
   ~~~

   



##### 存储过程语法

#### 存储过程进阶



### 游标

在 MySQL 中，存储过程或函数中的查询有时会返回多条记录，而使用简单的 SELECT 语句，没有办法得到第一行、下一行或前十行的数据，这时可以使用游标来逐条读取查询结果集中的记录

人理解游标就是一个标识，用来标识数据取到了什么地方

MySQL游标只能用于存储过程和函数，存储过程和函数处理完成后，游标就消失了

在存储过程中使用MySQL游标来遍历`SELECT`语句返回的结果集

#### 游标分类

敏感游标：敏感游标指向实际数据。Mysql游标是敏感的

不敏感游标：不敏感游标使用数据的临时副本。敏感游标比一个不敏感的游标执行得更快，因为它不需要临时拷贝数据

#### 声明游标

mysql中使用declare来声明游标，并定义响应的select语句，根据需要添加where和其他子句

~~~mysql
Declare cursor_name Cursor 
For select_statement;
~~~



#### 打开游标

声明游标之后，要想从游标中提取数据，必须首先打开游标。Mysql中通过Open关键字来实现。

打开一个游标时，游标并不指向第一条记录，而是指向第一条记录的前边，一个程序中，一个游标可以打开多次。用户打开游标后，其他用户或程序可能正在更新数据表，所有有时会导致用户每次打开游标后，显示的结果都不同

~~~mysql
open cursor_name;
~~~



#### 使用游标

游标打开后，使用Fetch...Into语句来读取数据

下列语句：将游标中select语句的执行结果保存到参数var_name中，变量参数var_name必须在游标使用之前定义。

使用游标类似数组变量，当第一个使用游标时，此时游标指向结果集的第一条记录

~~~mysql
Fetch cursor_name Into var_name1 [,var_name2]
~~~

Mysql的游标是只读的，也就是说只能顺序地从开始往后读取结果集，不能从后往前，也不能直接跳到中间记录



#### 关闭游标

游标使用完成之后，要及时关闭。一个游标关闭后，如果没有重新打开，则不能使用它。

如果没有手动关闭，Mysql会在到达End语句时会自动关闭它。游标关闭之后，不能使用fetch来使用游标

~~~mysql
Close cursor_name;
~~~



### 函数Function

#### 什么是函数

函数存储着一系列sql语句，调用函数就是一次性执行这些语句。所以函数可以降低语句重复

mysql函数内置很多自定义函数。例如：count、sum等等

#### 自定义函数

自定义函数分为标量值函数和表格值函数

##### 标量值函数

~~~sql
#语法
create [or replace] Function 函数名([parm1,parm2...])
Returns 返回值数据类型
as
begin
	sql语句
	return 变量/值;
end;

#调用函数
select 函数名(参数);
~~~



##### 表格值函数

内联表格值函数

~~~sql
create function 函数名(parm1,parm2...)
returns table
as
return (sql语句)
~~~

多句表格值函数

含义：包含多条sql语句，必须或者至少有一条给表格变量赋值

表格变量格式：returns @变量名(dt)  table(列定义 | 约束定义)

~~~sql
create function 函数名(参数)
returns @dt table (列定义)
as
begin 
	sql语句
end;
~~~



### 存储过程和函数区别

1. 存储过程不需要返回类型；函数必须返回类型
2. 存储过程用户在数据库中完成特定操作或者任务；函数用于执行任务后返回特定的数据
3. 存储过程的参数可以是in、out、inout类型；函数参数类型只能是in

可以认为存储函数是一个有返回值的存储过程，存储过程是一个没有返回值的存储函数





















