## CAP、BASE理论

### CAP

P是前提，然后在C和A之间选择

#### 一致性Consistency

1. 分布式环境中，一致性指数据在多个分布式节点中要能保持一致的特性，即：更新操作成功后，所有节点在同一时间的数据完全一致。
2. 假如客户端对其中一个节点的数据进行了更新操作，却没有使得其他节点的数据更新，这样就会出现各个节点之间的数据不一致，会导致客户端读到脏数据，如果能使其他节点的数据得到相应的更新，保证客户端每次读到都是最新的数据，此系统就认为具有强一致性
3. 一致性是在并发读写的时候才会出现的问题，因此在理解一致性问题时，一定要注意结合考虑并发读写的场景

#### 可用性Availability

可用性指系统只要不上宕机的情况下，那么该系统24小时对每一个请求操作都提供服务，在有限的时间对请求作出响应，称此系统具有高可用性

#### 分区容错性Partition tolerance

1. 分区容错性是指分布式系统在遇到任何网络分区故障的时候，仍然需要保证系统对外提供满足一致性和可用性服务，只要不是整个网络环境发生了故障
2. 分区容错性和扩展性紧密相关，在分布式应用中，分区容错性高指：在部分节点故障或出现丢包的情况下，集群系统仍然能提供服务，完成数据的访问。分区容错可视为在系统中采用多副本策略

例如：三个网络环境 北京、上海、深圳。部署在北京的机房网络出现故障，不影响上海和深圳的机房，上海和深圳的服务器还是能对外提供服务

![](https://gitee.com/qianchao_repo/pic-typora/raw/master/img/image-20220311132145766.png)

#### 相互关系

CA：如果不要求分区，则强一致性和可用性是同时可以保证的。但是分布式系统中分区问题是始终存在的，因此CA的分布式系统更多的是允许分区后各个子系统依然保持CA

CP：如果**不要求可用性**，相当于每个请求都需要在各个服务之间强一致性，也就是同步过程中，这个系统不对外提供服务，等系统同步完成后，再对外提供服务

AP：放弃强一致性，一旦分区发生，节点之间可能会失去联系，导致各个节点数据不一致。为了实现高可用，每个节点只能用本地数据提供服务，而这样就会导致全局数据不一致，请求的用户读到旧数据，对系统的影响不大

**为什么选择两个特性的原因**：为什么CAP理论，只能保其中两个。上面是一张简单的分布式系统图，两两互相通信。
如果CAP三个都满足。假设A，B，C三个服务各自保存了用户信息数据，现在用户对A发起了更新用户信息操作，那么服务A更新成功后，需要同步一下服务B和服务C，将服务B和服务C中的用户信息也进行更新，那么在服务A同步的过程中，可能就会出现用户对服务B发起读操作，那么用户可能就会读到还没有更新的数据(脏数据)，也就会出现数据不一致，不满足**C(一致性)**。如果要满足C的话，那就是在同步的过程中，整个分布式系统对外不提供服务，等数据同步完成后，再对外提供服务，这样就能满足C(一致性)了，但是这样又不满足**A(可用性)**，因为系统在这段时间内不对外提供服务。
如果要同时满足CA的话，我们可以将三个服务做成一个系统，也就是不想要进行同步操作，这样的话数据在一个系统中，这样即能满足一致性，又能对外提供服务，但是这样的话因为做成了一个系统，也就不存在分布式的概念，也就是不满足**P(分区容错性)**，已经没有了分区的概念了。所以一个分布式系统至多满足其中的两项

#### CAP结论

一个分布式系统基本上要保证P，那么只能在CA做取舍了，具体是舍弃C还是A的话，可以由具体的业务而定，如果我们的业务需要保证强一致性的话，那么我们就可以舍弃A可用性，来保证C了。而如果我们的系统对数据的一致性要求不高，那么我可以舍弃C，来保证系统的可用性A了。**像zookeeper就是保证了CP，舍弃了A。像eurekA就是保证AP，舍弃了C。**针对CAP，后面又出现BASE理论。

---



### BASE

1. Base理论是在CAP理论上进行改进的，对CAP中的一致性和可用性权衡的结果，既然CAP中无法做到强一致性和高可用性，那么可以采用适当的方式使系统达到最终一致性和基本可用的特点。
2. Base理论就是：Basically Available(基本可用)、Soft State(软状态)、Eventually consistency(最终一致)，它通过牺牲强一致性来获取可用性，允许数据在一段时间内是不一致的，但最终达到一致的状态。

#### 基本可用

假如舍弃A，系统无法对外提供服务，我们大可不必将整个系统的功能置为不可用，而是允许牺牲部分功能的可用性，其他的功能模块还是能对外提供服务，来保证系统的基本可用。

系统的基本可用体现在两个方面：

1. 一个是请求响应时间上的损失，也就是用户获取用户信息的请求可能处理时间比较长，需要等同步操作完成。这样系统还是能对外提供服务。
2. 还有一种就是功能上的损失，也就是在同步的过程中，将获取用户信息的接口禁用掉，不对外提供服务，将用户的请求引导到一个降级页面中，但是系统还是对外提供服务的，保证了系统的基本可用

#### 软状态

指系统中的数据存在中间状态，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时

#### 最终一致性

最终一致性跟强一致性不同的是，最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能够达到一个一致的状态，本质是需要系统最终数据能够达到一致，而不需要实时保证系统数据的强一致性

