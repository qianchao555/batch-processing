# Mongo

MongoDB是==面向文档==的NoSQL数据库，用于大量数据存储

## 主要功能

1. 每个数据库都包含集合，集合有包含文档
   - 每个文档可以具有不同数量的字段
   - 每个文档的大小和内容可以互不相同
2. MongoDB的行不需要预先定义结构，相反，可以动态创建字段



## MongoDB架构的关键组件

1. _id：这是每个mongoDB文档的必填字段，表示mongoDB文档中的唯一值
   - 类似于主键，创建新文档时，如果没有_id字段，会自动创建该字段
2. 集合：这是mongoDB中，文档的分组
   - 等效于：关系型数据库中的表
   - 集合存在于单个数据库中
3. 游标：指向查询结果集的指针
4. 数据库：集合的容器，类似于关系型数据库的某个库
5. 文档：mongoDB集合中的记录，称为文档
   - 类似于关系型数据库的某条记录
   - 文档包含字段名和值
6. 字段：文档中的key/value对，一个文档可以具有0个或多个字段
7. Json：可读性高，用于表示结构化数据的纯文本格式





## 为什么需要MongoDB

1. 面向文档的，将数据存储在文档中，使得mongoDB非常灵活，可以适应实际的业务环境和需求
2. 临时查询
   - MongoDB支持按照字段、范围、正则表达式搜索，可以查询返回文档中的特定字段
3. 索引
   - 可以创建索引，以提高mongoDB的搜索性能
   - 文档中的任何字段都可以建立索引
4. 复制：提供了副本集的高可用
5. 负载均衡
   - 使用分片的功能，实现水平扩展





## mongoDB的数据建模

mongo的数据具有灵活的架构，不会强制执行文档结构，使得mongo具有很强的灵活性

在mongo中，对数据建模时，应注意以下几点

1. 应用程序的需求是什么
   - 基于需求确定文档的结构
2. 数据检索模式
   - 例如：使用大量的查询操作，那么考虑在数据模型中使用索引来提高查询效率
3. 数据库是否频繁发生crud操作
   - 如果数据建模设计需要重新考虑使用索引或合并分片，以提高整体mongo环境的效率



## mongoDB创建数据库和集合

- 使用“use”命令创建数据库
- 使用insert()创建集合
- 使用insert()添加文档
- find()查询文档
- sort、limit、orders字句类似sql语句的作用
- 学习的时，看api就可以了



## mongoDB安全、监控、备份

安全

1. 启用访问控制
2. 配置基于角色的访问控制
3. 尝试将mongoDB配置为某种加密协议
4. 配置审计
5. 使用单独的用户ID运行mongoDB服务器实例



mongoDB备份程序：mongodump

1. 通过复制底层数据文件进行备份
2. 使用mongodump备份数据库
3. mongoDB cloud manager备份





## 数据库和集合

> MongoDB将Bson文档(即数据记录)，存储在集合Collection中，集合相当于关系型数据库表



### Collection

> 集合不存在时，在第一次存储数据到该集合时，Mongo会自动创建该集合



#### 文档

- 文档验证
  - 默认情况下，集合不要求其文档具有相同的模式，也就是说，单个集合的文档，不需要具有相同的字段集，且字段的数据类型在集合的不同文档之间可以不
  - 但是，从Mongo3.2开始，可以在更新和插入操作期间，对集合强制执行`文档验证规则`
- 修改文档结构
  - 可以动态更改集合中文档的结构。例如：添加新的字段、删除现有字段

#### 唯一标识符

> 集合被分配一个不变的UUID,且副本集的所有成员和分片集群中的分片的集合UUID均相同



#### 视图

> mongo3.4开始，可以基于已存在的集合或者视图传教只读的视图View
>
> 类似于Mysql的视图

- 视图是只读的，通过视图进行写操作会出现错误
- 视图使用其上游集合的索引
  - 索引是基于集合的，所以==不能基于视图==创建索引、删除、重建索引，也不能获取视图的索引列表
  - 也不能指定$natural排序
- 不能重命名视图
- 如果视图依赖的集合是分片的，那么视图也视为分片的
  - 因此，不能指定分片视图中的$lookup的from字段与$graphLookup操作
- 删除视图、修改视图



## 文档

> MongoDB将数据记录存储为BSON结构的文档，BSON,Binary JSON，Json文档的二进制表示形式



文档大小限制：Bson文档的最大大小为16MB

- 防止单个文档过大或在传输过程中占用过多的带宽
- 要存储大于最大大小的文档，Mongo提供了GridFS API





## CRUD

### 文本索引

Mongo支持对字符串内容的文本搜索查询，要执行文本搜索查询，必须在集合上有一个文本索引

- 一个集合只能有一个文本索引，但是该索引可以覆盖多个字段





# MongoDB关系

MongoDB的关系表示：多个文档之间在逻辑上的相互联系

文档之间可以通过：嵌入和引用来建立联系

- 嵌入式：把文档嵌入到其中
- 引用式：通过引用文档的`_id`字段来建立关系
  - 引用哪个数据库、哪个集合、哪个文档



Mongo中文档的关系可以是

- 1：1、1：N、N:1、N:N









# Mongo事务

Mongo中，对单个文档的操作是原子的

对于需要对多个文档（单个或多个集合中）进行原子性读写的场景，Mongo支持多文档事务。使用分布式事务，事务可以跨多个集合、数据库、文档和分片使用



多文档事务（分布式事务）

- 指的是分片集群和副本集群上的多文档事务



# Mongo索引

如果没有索引，mongo必须执行集合扫描，相当于Mysql的全表扫描

一个查询如果存在适当的索引，那么Mongo可以使用该索引来限制它必须检查的文档数量

Mongo的索引也是一种特殊的==数据结构==

- 索引存储一个或一组特定字段的值，按字段的值排序
- 索引项的排序支持有效的等值匹配和基于范围的查询操作

基本上，Mongo的索引与其他关系型数据库的索引类似



## 默认id索引

创建集合期间，Mongo在`_id`字段上创建唯一索引，该索引可以防止客户端插入两条具有相同值的文档

注意，在分片集群中，如果不使用`_id`字段作为分片键，那么应用程序必须确保`_id`的值的唯一性。这一特性通常是通过使用标准的自动生成的ObjectId来完成的



## 索引类型

单字段索引

复合索引：多字段上定义

- 复合索引中列出的字段顺序具有重要意义

文本索引

- 支持搜索集合中的字符串内容

多键索引

- 使用多键索引来索引存储在数组中的内容

地理空间索引

- 返回结果时使用平面几何的2d索引
- 使用球面几何返回的2d sphere索引



## 覆盖索引查询

- 所有的查询字段是索引的一部分
- 所有的查询，返回字段在同一个索引中

和MySQL的覆盖索引是类似的



不会使用覆盖索引的情况

- 所有索引字段是一个数组
- 所有索引字段是一个子文档







# MongoDB查询分析

使用的函数是：explain()、hint()。和mysql使用explain类似







​																																																																																												

# Change Streams

> 变更流，允许应用程序访问实时数据更改，而不会带来复杂性和延迟oplog的风险

应用程序使用变更流来订阅单个集合，数据库或整个部署中的所有数据变更，并立即对其做出反应

变更流可用于副本集和分片集







# MongoDB复制（副本集）

MongoDB的复制工具称为副本集，是生产部署的基础

MongoDB复制，是将数据同步在多个服务器的过程

它提供以下功能：

- 自动故障转移
- 数据冗余



类似于：Mysql的主从复制架构



副本集特征

- N个节点的集群
- 任何节点可能作为主节点
- 写操作都在主节点
- 自动故障转移、自动恢复



副本集中，包含多个数据承载节点和一个可选的仲裁节点

- 数据承载节点中，有且仅有一个主节点，其他是从节点
- 主节点：接收所有写操作
- 从节点：复制主节点的oplog日志,并将这些操作应用于它们自己的数据集
- 主节点不可用时，会触发选举操作



## 异步复制

从节点复制主节点的oplog，是异步操作的





# MongoDB分片

mongo中数据量很大时，会影响查询效率

mongo提出了分片的概念，将数据集拆分到多个MongoDB实例中



类似于：Mysql的分库分表



MongoDB的核心功能之一，是提供横向可扩展性

- 分片会将数据分布在机器集群上



分片主要组件

- Shard
  - 存储实际的数据块，生产环境中一个Shard Server角色可由几台机器做成一个replica set承担，防止主机单点故障。即将：一个主从架构构成一个Shard
- Config Server
  - mongo实例，存储了整个cluster metadata,其中包括chunk信息
- Query Routers
  - 前端路由，客户端由此接入，且让整个集群看上去像单个数据库，前端应用透明使用



# 正则表达式

基本上用于文档中发现字符串















