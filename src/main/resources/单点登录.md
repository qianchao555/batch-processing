## 单点登录

https://developer.aliyun.com/article/636281

单点登录：Single Sign On，即SSO

在多个应用系统中，只需要登录一次，就可以访问其他相互信任的应用系统





### 普通的登录认证机制



![image-20220317223116516](https://gitee.com/qianchao_repo/pic-typora/raw/master/img/202203172231252.png)

如图所示：

我们在浏览器中访问一个应用，这个应用需要登录，我们填写完用户名和密码后，完成登录认证。

这时应用将这个登录的用户的session登录状态设置为yes，同时浏览器中写入Cookie，这个Cookie是这个用户的唯一标识。下一次访问这个应用的时候，请求中会带上这个Cookie，服务端会根据这个Cookie找到对应的Session，通过Session来判断这个用户是否登录。如果不做特殊配置，这个Cookie的名字叫做 jsessionid，值在服务端是唯一的



### 同域下的单点登录

一般情况下一个企业只有一个域名，通过二级域名区分不同的系统

比如某个域名叫做：a.com，同时有两个业务系统分别为：app1.a.com和app2.a.com。我们要做单点登录，需要一个登录系统，叫做sso.a.com

只要做了sso.a.com单点登录，app1.a.com和app2.a.com也就可以自动登录了。

通过上面的登录认证机制，我们知道在sso.a.com中登录了，其实是在sso.a.com的服务端的session中记录了登录状态，同时在浏览器端的sso.a.com下写入了Cookie。那么怎么才能让app1.a.com和app2.a.com登录呢？

这里有两个问题：

- Cookie是不能跨越的，这里Cookie的domain属性是sso.a.com，在给app1和app2发送请求是带不上的
- sso、aap1、app2是不同的应用，他们的session存在自己的应用内的，是不共享的

如何解决这两个问题：

- 针对第一个问题：sso登录后，可以将Cookie的域设置为顶域，即 .a.com，这样所以子域的系统都可以访问到顶域的Cookie。在设置Cookie时，只能设置顶域和自己的域，不能设置其他域。比如：我们不能在自己的系统中给baidu.com的域设置Cookie
- 第二个session问题：在sso系统登录了，这时再访问app1，Cookie也带到了app1的服务端，app1的服务端怎么找到这个Cookie对应的session呢？这里就需要把3个应用的session共享，共享session的解决方案很多，例如：Spring-Session。这样第二个问题就解决了

![image-20220317225611854](https://gitee.com/qianchao_repo/pic-typora/raw/master/img/202203172256735.png)

这样，同域下的单点登录就实现了，但是这不是真正的单点登录



### 不同域下的单点登录

同域下的单点登录巧用了Cookie顶域的特性，但是不同域呢？不同域直接Cookie是不共享的，怎么办？

CAS流程：这个流程是单点登录的标准流程

1. 用户访问app系统，app系统是需要登录的，但用户现在没有登录
2. 跳转到CAS server，即SSO登录系统。SSO系统也没有登录，弹出用户登录页面
3. 用户填写用户名、密码，SSO系统进行认证后，将登录状态写入SSO的session，浏览器中写入SSO域下的Cookie
4. SSO系统登录完成后，会生成一个ST(Service Ticket)，然后跳转到app系统，同时将ST作为参数传递给app系统
5. app系统拿到ST后，从后台向SSO发送请求，验证ST是否有效
6. 验证通过后，app系统将登录状态写入session并设置app域下的Cookie

至此，跨域单点登录就完成了，以后再访问app系统时，app系统就是登录的。接下来，看看app2系统登录时的流程

1. 用户访问app2系统，app2系统没有登录，跳转到SSO
2. 由于SSO已经登录了，不需要重新登录验证
3. SSO生成ST，浏览器跳转到app2系统，并将ST作为参数传递给app2
4. app2拿到ST，后台访问SSO，验证ST是否有效
5. 验证成功后，app2将登录状态写入session，并在app2域下写入Cookie

这样app2系统不需要走登录流程，就已经登录了。SSO、app1、app2在不同的域，它们之间的session不共享也是没问题的



### 总结

1. 单点登录(SSO系统)是保障各个业务系统的用户资源的安全
2. 各个业务系统获取到的信息是这个用户能不能访问我的资源
3. 单点登录，资源都在各个业务系统，不做SSO这边。用户在给SSO服务器提供用户名和密码后，作为业务系统并不知道这件事情。 SSO随便给业务系统一个ST，那么业务系统是不能确定这个ST是用户伪造的，还是真的有效，所以要拿着这个ST去SSO服务器再问一下，这个用户给我的ST是否有效，是有效的我才能让这个用户访问













